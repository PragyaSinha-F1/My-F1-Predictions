<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Paddock 2026 | Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;900&family=Inter:wght@400;700&display=swap');
        body { background-color: #050505; color: white; font-family: 'Inter', sans-serif; }
        .f1-font { font-family: 'Outfit', sans-serif; font-weight: 900; text-transform: uppercase; font-style: italic; }
        .f1-glass { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); backdrop-filter: blur(12px); }
        .f1-red { color: #e10600; }
        .f1-bg-red { background-color: #e10600; }
        .pillar { transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const SB_URL = "https://gyzflcxqehesojhimokd.supabase.co"; 
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd5emZsY3hxZWhlc29qaGltb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMzQ4MjcsImV4cCI6MjA4MzcxMDgyN30.fOW7qr9cNEUp6otJU2f-tXtOJxRX4Wge9R76OXE-_Tk";
        const sb = supabase.createClient(SB_URL, SB_KEY);

        const TEAMS = {
            ferrari: { name: 'Ferrari', color: '#F91536' },
            redbull: { name: 'Red Bull Ford', color: '#3671C6' },
            mercedes: { name: 'Mercedes', color: '#6CD3BF' },
            mclaren: { name: 'McLaren', color: '#FF8000' },
            audi: { name: 'Audi F1', color: '#f5f5f5' },
            aston: { name: 'Aston Honda', color: '#229971' },
            rb: { name: 'Racing Bulls', color: '#6692FF' },
            williams: { name: 'Williams', color: '#64C4FF' },
            alpine: { name: 'Alpine', color: '#0093CC' },
            haas: { name: 'Haas', color: '#B6BABD' }
        };

        const CALENDAR_2026 = [
            { id: "aus", race: "Australian GP", date: "2026-03-15T11:30:00+05:30" },
            { id: "chn", race: "Chinese GP", date: "2026-03-22T12:30:00+05:30" },
            { id: "jpn", race: "Japanese GP", date: "2026-04-05T10:30:00+05:30" },
            { id: "bhr", race: "Bahrain GP", date: "2026-04-19T20:30:00+05:30" },
            { id: "sau", race: "Saudi GP", date: "2026-04-26T22:30:00+05:30" }
        ];

        const App = () => {
            const [view, setView] = useState('landing'); // landing, dashboard, race-room
            const [room, setRoom] = useState(null);
            const [selectedRaceId, setSelectedRaceId] = useState(null); // For Sub-Room view
            const [countdownRace, setCountdownRace] = useState(CALENDAR_2026[0]);
            const [timeLeft, setTimeLeft] = useState("");
            
            const [roomCodeInput, setRoomCodeInput] = useState('');
            const [isDrawerOpen, setIsDrawerOpen] = useState(false);
            const [formName, setFormName] = useState('');
            const [formTeam, setFormTeam] = useState('ferrari');
            const [predText, setPredText] = useState('');

            // --- COUNTDOWN LOGIC (IST) ---
            useEffect(() => {
                const timer = setInterval(() => {
                    const now = new Date().getTime();
                    const target = new Date(countdownRace.date).getTime();
                    const diff = target - now;

                    if (diff <= 0) {
                        setTimeLeft("RACE LIVE");
                    } else {
                        const d = Math.floor(diff / 86400000);
                        const h = Math.floor((diff % 86400000) / 3600000);
                        const m = Math.floor((diff % 3600000) / 60000);
                        const s = Math.floor((diff % 60000) / 1000);
                        setTimeLeft(`${d}d ${h}h ${m}m ${s}s`);
                    }
                }, 1000);
                return () => clearInterval(timer);
            }, [countdownRace]);

            // --- ACCURACY LOGIC ---
            // Calculate accuracy for a specific participant in a specific race
            const getRaceAcc = (participantId, raceId) => {
                const race = room?.data?.races?.find(r => r.id === raceId);
                if (!race) return 0;
                const preds = race.predictions?.filter(p => p.userId === participantId) || [];
                if (preds.length === 0) return 0;
                return Math.round((preds.filter(p => p.done).length / preds.length) * 100);
            };

            // Calculate total accumulated accuracy across all races for the main dashboard
            const getSeasonAcc = (participantId) => {
                const allRaces = room?.data?.races || [];
                let totalPreds = 0;
                let correctPreds = 0;
                allRaces.forEach(race => {
                    const preds = race.predictions?.filter(p => p.userId === participantId) || [];
                    totalPreds += preds.length;
                    correctPreds += preds.filter(p => p.done).length;
                });
                return totalPreds === 0 ? 0 : Math.round((correctPreds / totalPreds) * 100);
            };

            const sortedParticipants = (accFunc, raceId = null) => {
                return [...(room?.data?.participants || [])].sort((a, b) => {
                    const diff = accFunc(b.id, raceId) - accFunc(a.id, raceId);
                    return diff !== 0 ? diff : a.name.localeCompare(b.name);
                });
            };

            // --- DATABASE ACTIONS ---
            const refreshRoom = async (code) => {
                const { data, error } = await sb.from('f1_rooms').select().eq('code', code).single();
                if (data) setRoom(data);
            };

            const createRoom = async () => {
                const code = Math.random().toString(36).substring(2, 6).toUpperCase();
                const { data, error } = await sb.from('f1_rooms').insert([{ 
                    code, 
                    data: { participants: [], races: CALENDAR_2026.map(r => ({ id: r.id, race: r.race, predictions: [] })) } 
                }]).select().single();
                if (data) { setRoom(data); setView('dashboard'); }
            };

            const joinRoom = async (code) => {
                const { data } = await sb.from('f1_rooms').select().eq('code', code.toUpperCase()).single();
                if (data) { setRoom(data); setView('dashboard'); } else { alert("Room Not Found"); }
            };

            const updateRoomData = async (newData) => {
                const { error } = await sb.from('f1_rooms').update({ data: newData }).eq('code', room.code);
                if (!error) refreshRoom(room.code);
            };

            const deleteParticipant = (id) => {
                const filtered = room.data.participants.filter(p => p.id !== id);
                updateRoomData({ ...room.data, participants: filtered });
            };

            // --- RENDER HELPERS ---
            const getPodiumStyle = (pA, pB, accFunc, rId) => {
                const colorA = TEAMS[pA?.team]?.color || '#222';
                const colorB = TEAMS[pB?.team]?.color || '#222';
                if (pB && accFunc(pA?.id, rId) === accFunc(pB?.id, rId)) {
                    return { background: `repeating-linear-gradient(-45deg, ${colorA}, ${colorA} 15px, ${colorB} 15px, ${colorB} 30px)` };
                }
                return { background: colorA };
            };

            // --- VIEWS ---
            if (view === 'landing') return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 space-y-10">
                    <div className="text-center">
                        <h1 className="text-7xl f1-font italic tracking-tighter mb-2">F1<span className="f1-red">PADDOCK</span></h1>
                        <p className="text-[10px] font-bold tracking-[0.6em] opacity-30 uppercase">Strategy Hub 2026</p>
                    </div>

                    {/* Countdown Box */}
                    <div className="w-full max-w-md f1-glass rounded-[2rem] p-8 text-center border-t-2 border-red-600/30">
                        <select className="bg-transparent f1-font text-xs mb-4 outline-none f1-red" 
                                value={countdownRace.id} onChange={(e) => setCountdownRace(CALENDAR_2026.find(r => r.id === e.target.value))}>
                            {CALENDAR_2026.map(r => <option key={r.id} value={r.id} className="bg-black">{r.race}</option>)}
                        </select>
                        <div className="f1-font text-4xl mb-2 tracking-tighter">{timeLeft}</div>
                        <p className="text-[10px] font-bold opacity-30 uppercase tracking-widest italic">Until {countdownRace.race} (IST)</p>
                    </div>

                    <div className="w-full max-w-sm f1-glass p-8 rounded-[2.5rem] space-y-6">
                        <input className="w-full bg-transparent border-b border-zinc-800 p-2 text-2xl f1-font text-center outline-none uppercase" 
                               placeholder="ROOM CODE" value={roomCodeInput} onChange={e => setRoomCodeInput(e.target.value)} />
                        <div className="grid grid-cols-2 gap-4">
                            <button onClick={() => joinRoom(roomCodeInput)} className="f1-bg-red py-4 rounded-xl f1-font text-[10px]">JOIN ROOM</button>
                            <button onClick={createRoom} className="bg-zinc-900 py-4 rounded-xl f1-font text-[10px] border border-white/10">CREATE ROOM</button>
                        </div>
                    </div>
                </div>
            );

            if (view === 'dashboard' || view === 'race-room') {
                const isRaceView = view === 'race-room';
                const currentAccFunc = isRaceView ? getRaceAcc : getSeasonAcc;
                const rId = isRaceView ? selectedRaceId : null;
                const podiumSorted = sortedParticipants(currentAccFunc, rId);
                const [p1, p2, p3, p4] = podiumSorted;

                const tie12 = p1 && p2 && currentAccFunc(p1.id, rId) === currentAccFunc(p2.id, rId);
                const tie23 = p2 && p3 && currentAccFunc(p2.id, rId) === currentAccFunc(p3.id, rId);
                const tie34 = p3 && p4 && currentAccFunc(p3.id, rId) === currentAccFunc(p4.id, rId);

                return (
                    <div className="max-w-5xl mx-auto p-6 pt-10">
                        {/* Global Header */}
                        <div className="flex justify-between items-center mb-8">
                            <button onClick={() => isRaceView ? setView('dashboard') : setView('landing')} className="f1-font text-[10px] opacity-40 hover:opacity-100">‚Üê {isRaceView ? 'BACK TO SEASON' : 'EXIT'}</button>
                            <div className="flex items-center gap-3">
                                <h2 className="f1-font text-xl italic">üèÅ {room.code}</h2>
                                <button onClick={() => {navigator.clipboard.writeText(room.code); alert("Copied!")}} className="p-2 bg-zinc-900 rounded-lg text-[10px] font-bold">COPY</button>
                            </div>
                            <button onClick={() => setIsDrawerOpen(true)} className="f1-bg-red px-6 py-2 rounded-lg f1-font text-[10px]">MANAGE GRID</button>
                        </div>

                        {/* Title Section */}
                        <div className="mb-10 text-center">
                            <h3 className="f1-font text-4xl italic tracking-tighter">
                                {isRaceView ? CALENDAR_2026.find(r => r.id === rId).race : "SEASON STANDINGS"}
                            </h3>
                            <p className="text-[10px] font-bold opacity-30 uppercase tracking-[0.4em]">{isRaceView ? 'Race Specific Podium' : 'Accumulated Accuracy'}</p>
                        </div>

                        {/* TIE-LOGIC PODIUM */}
                        <div className="f1-glass rounded-[3rem] h-[400px] p-8 flex items-end justify-center gap-4 relative overflow-hidden mb-12 border-b-4 border-red-600/20">
                            <div className="flex-1 flex flex-col items-center">
                                <p className="text-[9px] font-bold mb-2 uppercase truncate w-full text-center px-2">{tie23 ? `${p2?.name} & ${p3?.name}` : (p2?.name || '---')}</p>
                                <div className="pillar w-full rounded-t-xl flex items-center justify-center f1-font text-4xl italic" 
                                    style={{ height: p2 ? '150px' : '40px', ...getPodiumStyle(p2, p3, currentAccFunc, rId), color: p2?.team === 'audi' ? '#000' : '#fff' }}>
                                    {tie23 ? '=' : '2'}
                                </div>
                            </div>
                            <div className="flex-1 flex flex-col items-center">
                                <p className="f1-font text-sm mb-2 uppercase truncate w-full text-center px-2">{tie12 ? `${p1?.name} & ${p2?.name}` : (p1?.name || '---')}</p>
                                <div className="pillar w-full rounded-t-xl flex items-center justify-center f1-font text-7xl italic shadow-2xl" 
                                    style={{ height: p1 ? '230px' : '40px', ...getPodiumStyle(p1, p2, currentAccFunc, rId), color: p1?.team === 'audi' ? '#000' : '#fff' }}>1</div>
                            </div>
                            <div className="flex-1 flex flex-col items-center">
                                <p className="text-[9px] font-bold mb-2 uppercase truncate w-full text-center px-2">{tie34 ? `${p3?.name} & ${p4?.name}` : (p3?.name || '---')}</p>
                                <div className="pillar w-full rounded-t-xl flex items-center justify-center f1-font text-2xl italic" 
                                    style={{ height: p3 ? '100px' : '40px', ...getPodiumStyle(p3, p4, currentAccFunc, rId), color: p3?.team === 'audi' ? '#000' : '#fff' }}>
                                    {tie34 ? '=' : '3'}
                                </div>
                            </div>
                        </div>

                        {/* List Area */}
                        {!isRaceView ? (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {CALENDAR_2026.map(r => (
                                    <div key={r.id} onClick={() => { setSelectedRaceId(r.id); setView('race-room'); }} className="f1-glass p-6 rounded-[2rem] flex justify-between items-center cursor-pointer hover:bg-white/10 transition">
                                        <div className="f1-font text-lg italic">{r.race}</div>
                                        <div className="text-[10px] font-bold opacity-30 uppercase">ENTER SUB-ROOM ‚Üí</div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="space-y-4">
                                <div className="flex gap-2 mb-8">
                                    <input className="flex-1 f1-glass p-4 rounded-xl bg-transparent border-zinc-800 outline-none" 
                                           placeholder="LOG PREDICTION (e.g. Hamilton P1)..." value={predText} onChange={e => setPredText(e.target.value)} />
                                    <select id="userSel" className="bg-zinc-900 p-4 rounded-xl text-xs f1-font">
                                        {room.data.participants.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                                    </select>
                                    <button onClick={() => {
                                        const uid = document.getElementById('userSel').value;
                                        if(!predText) return;
                                        const updatedRaces = room.data.races.map(r => r.id === rId ? 
                                            {...r, predictions: [...r.predictions, { id: Date.now(), userId: uid, text: predText, done: false }]} : r
                                        );
                                        updateRoomData({...room.data, races: updatedRaces});
                                        setPredText('');
                                    }} className="f1-bg-red px-8 rounded-xl f1-font text-xs">ADD</button>
                                </div>
                                {room.data.races.find(r => r.id === rId).predictions.map(pr => {
                                    const user = room.data.participants.find(u => u.id === pr.userId);
                                    return (
                                        <div key={pr.id} className="f1-glass p-4 rounded-2xl flex items-center justify-between">
                                            <div className="flex items-center gap-4">
                                                <div className="w-2 h-10 rounded" style={{background: TEAMS[user?.team]?.color}}></div>
                                                <div>
                                                    <p className="text-[10px] font-bold opacity-30 uppercase">{user?.name}</p>
                                                    <p className={`italic ${pr.done ? 'line-through opacity-30' : ''}`}>{pr.text}</p>
                                                </div>
                                            </div>
                                            <button onClick={() => {
                                                const updatedRaces = room.data.races.map(r => r.id === rId ? 
                                                    {...r, predictions: r.predictions.map(p => p.id === pr.id ? {...p, done: !p.done} : p)} : r
                                                );
                                                updateRoomData({...room.data, races: updatedRaces});
                                            }} className={`p-2 rounded-lg text-[10px] font-bold ${pr.done ? 'bg-green-600' : 'bg-zinc-800'}`}>
                                                {pr.done ? 'CORRECT' : 'MARK WIN'}
                                            </button>
                                        </div>
                                    )
                                })}
                            </div>
                        )}

                        {/* Participant Management Drawer */}
                        {isDrawerOpen && (
                            <div className="fixed inset-0 z-[100] flex justify-end">
                                <div className="absolute inset-0 bg-black/90 backdrop-blur-md" onClick={() => setIsDrawerOpen(false)} />
                                <div className="relative w-full max-w-sm bg-[#080808] border-l border-zinc-900 p-10 flex flex-col overflow-y-auto">
                                    <h3 className="f1-font text-2xl italic mb-8">Manage Grid</h3>
                                    
                                    <div className="space-y-4 mb-10">
                                        <input className="w-full bg-zinc-900 border border-zinc-800 p-4 rounded-xl text-sm" 
                                            placeholder="NAME" value={formName} onChange={e => setFormName(e.target.value)} />
                                        <select className="w-full bg-zinc-900 border border-zinc-800 p-4 rounded-xl text-xs font-bold uppercase"
                                            value={formTeam} onChange={e => setFormTeam(e.target.value)}>
                                            {Object.entries(TEAMS).map(([id, t]) => (<option key={id} value={id}>{t.name}</option>))}
                                        </select>
                                        <button onClick={() => {
                                            if(!formName) return;
                                            updateRoomData({...room.data, participants: [...room.data.participants, { id: 'u'+Date.now(), name: formName, team: formTeam }]});
                                            setFormName('');
                                        }} className="w-full f1-bg-red py-4 rounded-xl f1-font text-[10px]">ADD TO SESSION</button>
                                    </div>

                                    <div className="space-y-2">
                                        <p className="text-[10px] font-bold opacity-30 uppercase mb-4">Current Participants</p>
                                        {room.data.participants.map(p => (
                                            <div key={p.id} className="flex items-center justify-between p-3 bg-zinc-900 rounded-xl">
                                                <span className="f1-font text-xs">{p.name}</span>
                                                <button onClick={() => deleteParticipant(p.id)} className="text-red-600 font-bold text-xs px-2">DELETE</button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
