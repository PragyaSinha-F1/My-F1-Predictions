<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Predictions 2026 | IST</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        @font-face { font-family: 'Formula1'; src: url('https://smart-realty.com.ua/fonts/Formula1-Black.woff2') format('woff2'); font-weight: 900; }
        body { background-color: #050505; color: #e4e4e7; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .f1-font { font-family: 'Formula1', sans-serif; }
        .f1-glass { background: rgba(15, 15, 15, 0.8); border: 1px solid rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); }
        .f1-red { color: #e10600; }
        .f1-bg-red { background-color: #e10600; }
        .drawer-slide { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .podium-pillar { transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .luminous-text { text-shadow: 0 0 10px rgba(225, 6, 0, 0.8), 0 0 20px rgba(225, 6, 0, 0.4); }
        .progress-ring__circle { transition: stroke-dashoffset 0.35s; transform: rotate(-90deg); transform-origin: 50% 50%; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const SB_URL = "https://gyzflcxqehesojhimokd.supabase.co"; 
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd5emZsY3hxZWhlc29qaGltb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMzQ4MjcsImV4cCI6MjA4MzcxMDgyN30.fOW7qr9cNEUp6otJU2f-tXtOJxRX4Wge9R76OXE-_Tk";
        const sb = supabase.createClient(SB_URL, SB_KEY);

        const TEAMS = {
            redbull: { name: 'Red Bull Ford', color: '#3671C6' }, ferrari: { name: 'Ferrari', color: '#F91536' },
            mclaren: { name: 'McLaren', color: '#FF8000' }, mercedes: { name: 'Mercedes', color: '#6CD3BF' },
            aston: { name: 'Aston Honda', color: '#229971' }, audi: { name: 'Audi F1', color: '#f5f5f5' }, 
            alpine: { name: 'Alpine', color: '#0093CC' }, haas: { name: 'Haas', color: '#B6BABD' },
            williams: { name: 'Williams', color: '#64C4FF' }, rb: { name: 'Racing Bulls', color: '#6692FF' }
        };

        const CALENDAR_2026 = [
            { name: "Australia", date: "2026-03-08" }, { name: "China", date: "2026-03-15" },
            { name: "Japan", date: "2026-03-29" }, { name: "Bahrain", date: "2026-04-12" },
            { name: "Saudi Arabia", date: "2026-04-19" }, { name: "Miami", date: "2026-05-03" },
            { name: "Canada", date: "2026-05-24" }, { name: "Monaco", date: "2026-06-07" },
            { name: "Barcelona", date: "2026-06-14" }, { name: "Austria", date: "2026-06-28" },
            { name: "Great Britain", date: "2026-07-05" }, { name: "Belgium", date: "2026-07-19" },
            { name: "Hungary", date: "2026-07-26" }, { name: "Netherlands", date: "2026-08-23" },
            { name: "Italy (Monza)", date: "2026-09-06" }, { name: "Spain (Madrid)", date: "2026-09-13" },
            { name: "Azerbaijan", date: "2026-09-26" }, { name: "Singapore", date: "2026-10-11" },
            { name: "USA (Austin)", date: "2026-10-25" }, { name: "Mexico", date: "2026-11-01" },
            { name: "Brazil", date: "2026-11-08" }, { name: "Las Vegas", date: "2026-11-21" },
            { name: "Qatar", date: "2026-11-29" }, { name: "Abu Dhabi", date: "2026-12-06" }
        ];

        function ProgressCircle({ current, total }) {
            const radius = 36;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (current / total) * circumference;
            return (
                <div className="flex flex-col items-center justify-center p-4">
                    <div className="relative">
                        <svg width="100" height="100">
                            <circle className="text-zinc-800" strokeWidth="8" stroke="currentColor" fill="transparent" r={radius} cx="50" cy="50" />
                            <circle className="f1-red progress-ring__circle" strokeWidth="8" strokeDasharray={circumference} strokeDashoffset={offset} strokeLinecap="round" stroke="currentColor" fill="transparent" r={radius} cx="50" cy="50" />
                        </svg>
                        <div className="absolute inset-0 flex flex-col items-center justify-center">
                            <span className="f1-font text-xl italic">{current}/{total}</span>
                        </div>
                    </div>
                    <p className="text-[9px] font-black uppercase mt-2 opacity-40 tracking-widest italic">Season Progress</p>
                </div>
            );
        }

        function App() {
            const [view, setView] = useState('landing');
            const [room, setRoom] = useState(null);
            const [participants, setParticipants] = useState([]);
            const [isLocked, setIsLocked] = useState(false);
            const [activeUserId, setActiveUserId] = useState(null);
            const [roomInput, setRoomInput] = useState('');
            const [newRoomName, setNewRoomName] = useState('');
            const [userName, setUserName] = useState('');
            const [userTeam, setUserTeam] = useState('redbull');
            const [isDrawerOpen, setIsDrawerOpen] = useState(false);
            const [history, setHistory] = useState(JSON.parse(localStorage.getItem('f1_history') || '[]'));
            const [selectedRaceIdx, setSelectedRaceIdx] = useState(0);

            const now = new Date();
            const daysRemaining = Math.ceil((new Date(CALENDAR_2026[selectedRaceIdx].date) - now) / (1000 * 60 * 60 * 24));
            const completedRaces = CALENDAR_2026.filter(r => new Date(r.date) < now).length;

            const saveToHistory = (code, name) => {
                const newHist = [{code, name}, ...history.filter(h => h.code !== code)].slice(0, 8);
                setHistory(newHist);
                localStorage.setItem('f1_history', JSON.stringify(newHist));
            };

            const permanentDelete = async (e, code) => {
                e.stopPropagation();
                if(!confirm(`PERMANENTLY DELETE ROOM ${code}?`)) return;
                await sb.from('f1_rooms').delete().eq('code', code);
                const newHist = history.filter(h => h.code !== code);
                setHistory(newHist);
                localStorage.setItem('f1_history', JSON.stringify(newHist));
            };

            const getAcc = (p) => {
                if (!p?.predictions || p.predictions.length === 0) return 0;
                return Math.round((p.predictions.filter(x => x.done).length / p.predictions.length) * 100);
            };

            const updateDB = async (newList, lockState) => {
                setParticipants(newList);
                setIsLocked(lockState);
                await sb.from('f1_rooms').update({ data: { participants: newList, isLocked: lockState } }).eq('code', room.code);
            };

            const handleJoin = async (code) => {
                const { data } = await sb.from('f1_rooms').select().eq('code', code.toUpperCase()).single();
                if (data) { 
                    setRoom(data); setParticipants(data.data.participants || []); setIsLocked(data.data.isLocked || false); 
                    saveToHistory(data.code, data.name); setView('dashboard'); 
                } else { alert("Room not found"); }
            };

            const handleCreate = async () => {
                if (!newRoomName) return;
                const code = Math.random().toString(36).substring(2, 6).toUpperCase();
                const { data } = await sb.from('f1_rooms').insert([{ code, name: newRoomName, data: { participants: [], isLocked: false } }]).select().single();
                if (data) {
                    setRoom(data); setParticipants([]); setIsLocked(false);
                    saveToHistory(code, newRoomName); setView('dashboard');
                }
            };

            if (view === 'landing') return (
                <div className="max-w-6xl mx-auto p-6 pt-12 min-h-screen flex flex-col">
                    <h1 className="text-4xl font-black uppercase f1-font italic mb-12 tracking-tighter text-center">F1 <span className="f1-red">PADDOCK</span></h1>
                    
                    <div className="grid lg:grid-cols-3 gap-8 flex-1">
                        <div className="space-y-6">
                            <div className="f1-glass p-8 rounded-3xl">
                                <h2 className="f1-font text-[10px] mb-6 opacity-50 uppercase tracking-widest">Join Grid</h2>
                                <input className="w-full bg-transparent border-b border-zinc-800 p-4 mb-6 text-center outline-none font-bold uppercase" placeholder="CODE" value={roomInput} onChange={e => setRoomInput(e.target.value)} />
                                <button onClick={() => handleJoin(roomInput)} className="w-full bg-zinc-800 p-4 rounded-xl font-black uppercase text-xs">Join</button>
                            </div>
                            <div className="f1-glass p-8 rounded-3xl">
                                <h2 className="f1-font text-[10px] mb-6 opacity-50 uppercase tracking-widest">New Session</h2>
                                <input className="w-full bg-transparent border-b border-zinc-800 p-4 mb-6 text-center outline-none font-bold uppercase" placeholder="NAME" value={newRoomName} onChange={e => setNewRoomName(e.target.value)} />
                                <button onClick={handleCreate} className="w-full f1-bg-red p-4 rounded-xl font-black uppercase text-xs">Create Room</button>
                            </div>
                        </div>

                        <div className="f1-glass p-8 rounded-[2.5rem]">
                            <h2 className="f1-font text-[10px] mb-8 opacity-50 uppercase tracking-widest italic">Recent Rooms</h2>
                            <div className="space-y-4 max-h-[400px] overflow-y-auto pr-2">
                                {history.length === 0 && <p className="text-xs opacity-20 italic">No history yet...</p>}
                                {history.map(h => (
                                    <div key={h.code} onClick={() => handleJoin(h.code)} className="bg-white/5 p-5 rounded-2xl flex items-center justify-between cursor-pointer hover:bg-white/10 transition group">
                                        <div><p className="font-black italic uppercase text-sm group-hover:text-red-500 transition">{h.name}</p>
                                        <p className="text-[10px] opacity-40 font-bold tracking-widest uppercase">{h.code}</p></div>
                                        <button onClick={(e) => permanentDelete(e, h.code)} className="text-xs opacity-0 group-hover:opacity-40 hover:!opacity-100 px-3 py-2 text-red-500 font-bold">DELETE</button>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="f1-glass p-8 rounded-[2.5rem] flex flex-col justify-between">
                            <div>
                                <h2 className="f1-font text-[10px] mb-6 opacity-50 uppercase tracking-widest italic text-center">Race Control</h2>
                                <select className="w-full bg-zinc-900 p-3 rounded-xl text-xs font-bold uppercase outline-none mb-6 border border-zinc-800" value={selectedRaceIdx} onChange={e => setSelectedRaceIdx(e.target.value)}>
                                    {CALENDAR_2026.map((r, i) => <option key={i} value={i}>{r.name}</option>)}
                                </select>
                            </div>
                            <div className="text-center">
                                <p className="text-6xl font-black f1-font f1-red italic tracking-tighter uppercase mb-2 leading-none">{daysRemaining}</p>
                                <p className="text-xs font-black opacity-40 tracking-[0.3em] uppercase">Days Until Lights Out</p>
                            </div>
                            <div className="mt-8 pt-6 border-t border-zinc-900 text-center">
                                <p className="text-sm font-black italic uppercase opacity-60 tracking-tighter">{CALENDAR_2026[selectedRaceIdx].name} GP</p>
                                <p className="text-[10px] font-bold opacity-30 uppercase">{new Date(CALENDAR_2026[selectedRaceIdx].date).toDateString()}</p>
                            </div>
                        </div>
                    </div>
                </div>
            );

            if (view === 'dashboard') {
                const sorted = [...participants].sort((a, b) => getAcc(b) - getAcc(a));
                const p1 = sorted[0], p2 = sorted[1], p3 = sorted[2];

                return (
                    <div className="max-w-5xl mx-auto p-6 pt-10">
                        <div className={`fixed top-0 right-0 h-full w-80 f1-glass border-l border-zinc-800 z-50 p-8 drawer-slide ${isDrawerOpen ? 'translate-x-0 shadow-2xl' : 'translate-x-full'}`}>
                            <div className="flex justify-between items-center mb-10">
                                <h3 className="f1-font text-xs uppercase italic tracking-widest">New Strategist</h3>
                                <button onClick={() => setIsDrawerOpen(false)} className="text-xl opacity-40 hover:opacity-100">‚úï</button>
                            </div>
                            <div className="space-y-6">
                                <input className="w-full bg-zinc-900 p-4 rounded-xl text-xs font-bold uppercase outline-none focus:ring-1 ring-red-500" placeholder="E.G. MAX" value={userName} onChange={e => setUserName(e.target.value)} />
                                <select className="w-full bg-zinc-900 p-4 rounded-xl text-xs font-bold uppercase text-white outline-none" value={userTeam} onChange={e => setUserTeam(e.target.value)}>
                                    {Object.entries(TEAMS).map(([id, t]) => <option key={id} value={id}>{t.name}</option>)}
                                </select>
                                <button onClick={() => { if(userName) updateDB([...participants, {id: Date.now(), name: userName, color: userTeam, predictions: []}], isLocked); setUserName(''); setIsDrawerOpen(false); }} className="w-full f1-bg-red p-5 rounded-xl font-black uppercase text-[10px] mt-4">Add to Grid</button>
                            </div>
                        </div>

                        <header className="flex justify-between items-center mb-8">
                            <div className="flex items-center gap-6">
                                <button onClick={() => setView('landing')} className="text-[10px] font-black opacity-30 hover:opacity-100 uppercase tracking-widest transition">‚Üê EXIT</button>
                                <h2 className="f1-font text-lg uppercase italic tracking-tighter luminous-text f1-red">üèÅ {room.name}</h2>
                            </div>
                            <div className="flex items-center gap-4">
                                {!isLocked && <button onClick={() => setIsDrawerOpen(true)} className="w-10 h-10 rounded-full bg-zinc-800 flex items-center justify-center hover:bg-zinc-700 transition shadow-lg border border-white/5">Ôºã</button>}
                                <button onClick={() => updateDB(participants, !isLocked)} className={`px-5 py-2 rounded-full text-[9px] font-black tracking-[0.2em] uppercase ${isLocked ? 'bg-zinc-800 text-green-500' : 'bg-red-600 text-white'}`}>{isLocked ? 'üîì UNLOCKED' : 'üîí LOCK GRID'}</button>
                            </div>
                        </header>

                        <div className="grid lg:grid-cols-4 gap-6 mb-10">
                            <div className="lg:col-span-3 f1-glass rounded-[2.5rem] p-8 flex items-end justify-center gap-4 h-[300px]">
                                <div className="flex-1 text-center">
                                    <p className="text-[9px] font-black mb-2 uppercase opacity-60 italic">{p2?.name || '-'}</p>
                                    <div className="podium-pillar rounded-t-2xl flex items-center justify-center text-4xl font-black italic text-black/20" style={{ height: p2 ? '140px' : '30px', background: p2 ? TEAMS[p2.color].color : '#111' }}>2</div>
                                </div>
                                <div className="flex-1 text-center">
                                    <p className="text-xs font-black mb-2 uppercase italic">{p1?.name || '-'}</p>
                                    <div className="podium-pillar rounded-t-2xl border-t-4 border-white/20 flex items-center justify-center text-6xl font-black italic text-black/30" style={{ height: p1 ? '200px' : '30px', background: p1 ? TEAMS[p1.color].color : '#222' }}>1</div>
                                </div>
                                <div className="flex-1 text-center">
                                    <p className="text-[9px] font-black mb-2 uppercase opacity-60 italic">{p3?.name || '-'}</p>
                                    <div className="podium-pillar rounded-t-2xl flex items-center justify-center text-3xl font-black italic text-black/20" style={{ height: p3 ? '90px' : '30px', background: p3 ? TEAMS[p3.color].color : '#0a0a0a' }}>3</div>
                                </div>
                            </div>
                            <div className="f1-glass rounded-[2.5rem] flex items-center justify-center">
                                <ProgressCircle current={completedRaces} total={24} />
                            </div>
                        </div>

                        <div className="grid md:grid-cols-3 gap-6">
                            {participants.map(p => (
                                <div key={p.id} onClick={() => { setActiveUserId(p.id); setView('predictions'); }} className="f1-glass p-6 rounded-3xl border-l-4 relative group hover:bg-white/5 transition border border-zinc-900 cursor-pointer" style={{borderLeftColor: TEAMS[p.color].color}}>
                                    <button onClick={(e) => { e.stopPropagation(); updateDB(participants.filter(x => x.id !== p.id), isLocked); }} className="absolute top-4 right-4 text-zinc-800 hover:text-red-500 opacity-0 group-hover:opacity-100 transition">‚úï</button>
                                    <p className="text-[8px] font-black opacity-40 uppercase mb-1">{TEAMS[p.color].name}</p>
                                    <h4 className="text-xl font-black italic uppercase mb-4 tracking-tight">{p.name}</h4>
                                    <div className="flex justify-between items-center bg-black/40 p-4 rounded-2xl">
                                        <span className="text-[9px] font-bold opacity-30 uppercase tracking-widest italic">Accuracy</span>
                                        <span className="font-black f1-red text-xl italic">{getAcc(p)}%</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }

            if (view === 'predictions') {
                const activeUser = participants.find(u => u.id === activeUserId);
                const [pInput, setPInput] = useState('');
                
                if (!activeUser) return null;

                return (
                    <div className="max-w-xl mx-auto p-6 pt-12">
                        <button onClick={() => setView('dashboard')} className="mb-10 text-[10px] font-black opacity-30 uppercase tracking-widest hover:opacity-100 transition italic">‚Üê BACK TO GRID</button>
                        <div className="mb-12 border-l-8 p-8 bg-white/5 rounded-r-3xl flex justify-between items-end border-zinc-800" style={{borderColor: TEAMS[activeUser.color].color}}>
                            <div><h1 className="text-5xl font-black italic uppercase leading-none f1-font tracking-tighter">{activeUser.name}</h1>
                            <p className="text-[10px] opacity-40 font-black mt-4 tracking-[0.4em] uppercase italic">{TEAMS[activeUser.color].name}</p></div>
                            <p className="text-5xl font-black f1-red italic">{getAcc(activeUser)}%</p>
                        </div>
                        {!isLocked && (
                            <div className="flex gap-2 mb-10">
                                <input className="flex-1 bg-zinc-900 border border-zinc-800 p-4 rounded-xl outline-none font-bold text-xs uppercase" placeholder="ADD PREDICTION..." value={pInput} onChange={e => setPInput(e.target.value)} />
                                <button onClick={() => { 
                                    if(!pInput) return; 
                                    const newList = participants.map(u => u.id === activeUser.id ? {...u, predictions: [...u.predictions, {id: Date.now(), text: pInput, done: false}]} : u);
                                    updateDB(newList, isLocked); 
                                    setPInput(''); 
                                }} className="f1-bg-red px-8 rounded-xl font-black text-[10px]">ADD</button>
                            </div>
                        )}
                        <div className="space-y-3">
                            {activeUser.predictions.map(pr => (
                                <div key={pr.id} className="f1-glass p-5 rounded-2xl flex items-center justify-between">
                                    <div className="flex items-center gap-6 cursor-pointer flex-1" onClick={() => { 
                                        const newList = participants.map(u => u.id === activeUser.id ? {
                                            ...u, 
                                            predictions: u.predictions.map(x => x.id === pr.id ? {...x, done: !x.done} : x)
                                        } : u);
                                        updateDB(newList, isLocked);
                                    }}>
                                        <div className={`w-6 h-6 rounded flex items-center justify-center border-2 transition-all ${pr.done ? 'bg-green-500 border-green-500' : 'border-zinc-700'}`}>{pr.done && <span className="text-black font-black text-xs">‚úì</span>}</div>
                                        <span className={`text-sm font-black italic uppercase ${pr.done ? 'opacity-20 line-through' : ''}`}>{pr.text}</span>
                                    </div>
                                    <button onClick={() => { 
                                        const newList = participants.map(u => u.id === activeUser.id ? {
                                            ...u, 
                                            predictions: u.predictions.filter(x => x.id !== pr.id)
                                        } : u);
                                        updateDB(newList, isLocked);
                                    }} className="text-red-500 opacity-30 hover:opacity-100 px-2">‚úï</button>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
