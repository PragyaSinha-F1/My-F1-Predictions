<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Predictions 2026 | IST</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        /* Using a reliable F1-style font backup to avoid CORS issues */
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@900&display=swap');
        
        body { background-color: #050505; color: #e4e4e7; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .f1-font { font-family: 'Outfit', sans-serif; font-weight: 900; text-transform: uppercase; font-style: italic; }
        .f1-glass { background: rgba(15, 15, 15, 0.8); border: 1px solid rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); }
        .f1-red { color: #e10600; }
        .f1-bg-red { background-color: #e10600; }
        .luminous-text { text-shadow: 0 0 10px rgba(225, 6, 0, 0.8), 0 0 20px rgba(225, 6, 0, 0.4); }
        .progress-ring__circle { transition: stroke-dashoffset 0.35s; transform: rotate(-90deg); transform-origin: 50% 50%; }
        .podium-pillar { transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const SB_URL = "https://gyzflcxqehesojhimokd.supabase.co"; 
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd5emZsY3hxZWhlc29qaGltb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMzQ4MjcsImV4cCI6MjA4MzcxMDgyN30.fOW7qr9cNEUp6otJU2f-tXtOJxRX4Wge9R76OXE-_Tk";
        const sb = supabase.createClient(SB_URL, SB_KEY);

        const TEAMS = {
            redbull: { name: 'Red Bull Ford', color: '#3671C6' }, ferrari: { name: 'Ferrari', color: '#F91536' },
            mclaren: { name: 'McLaren', color: '#FF8000' }, mercedes: { name: 'Mercedes', color: '#6CD3BF' },
            aston: { name: 'Aston Honda', color: '#229971' }, audi: { name: 'Audi F1', color: '#f5f5f5' }, 
            alpine: { name: 'Alpine', color: '#0093CC' }, haas: { name: 'Haas', color: '#B6BABD' },
            williams: { name: 'Williams', color: '#64C4FF' }, rb: { name: 'Racing Bulls', color: '#6692FF' }
        };

        const CALENDAR_2026 = [
            { name: "Australia", date: "2026-03-08" }, { name: "China", date: "2026-03-15" },
            { name: "Japan", date: "2026-03-29" }, { name: "Bahrain", date: "2026-04-12" },
            { name: "Saudi Arabia", date: "2026-04-19" }, { name: "Miami", date: "2026-05-03" },
            { name: "Canada", date: "2026-05-24" }, { name: "Monaco", date: "2026-06-07" },
            { name: "Barcelona", date: "2026-06-14" }, { name: "Austria", date: "2026-06-28" },
            { name: "Great Britain", date: "2026-07-05" }, { name: "Belgium", date: "2026-07-19" },
            { name: "Hungary", date: "2026-07-26" }, { name: "Netherlands", date: "2026-08-23" },
            { name: "Italy (Monza)", date: "2026-09-06" }, { name: "Spain (Madrid)", date: "2026-09-13" },
            { name: "Azerbaijan", date: "2026-09-26" }, { name: "Singapore", date: "2026-10-11" },
            { name: "USA (Austin)", date: "2026-10-25" }, { name: "Mexico", date: "2026-11-01" },
            { name: "Brazil", date: "2026-11-08" }, { name: "Las Vegas", date: "2026-11-21" },
            { name: "Qatar", date: "2026-11-29" }, { name: "Abu Dhabi", date: "2026-12-06" }
        ];

        function ProgressCircle({ current, total }) {
            const radius = 36;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (current / total) * circumference;
            return (
                <div className="flex flex-col items-center justify-center p-4">
                    <div className="relative">
                        <svg width="100" height="100">
                            <circle className="text-zinc-800" strokeWidth="8" stroke="currentColor" fill="transparent" r={radius} cx="50" cy="50" />
                            <circle className="f1-red progress-ring__circle" strokeWidth="8" strokeDasharray={circumference} strokeDashoffset={offset} strokeLinecap="round" stroke="currentColor" fill="transparent" r={radius} cx="50" cy="50" />
                        </svg>
                        <div className="absolute inset-0 flex flex-col items-center justify-center">
                            <span className="f1-font text-xl italic">{current}/{total}</span>
                        </div>
                    </div>
                    <p className="text-[9px] font-black uppercase mt-2 opacity-40 tracking-widest italic">Season Progress</p>
                </div>
            );
        }

        function App() {
            const [view, setView] = useState('landing');
            const [room, setRoom] = useState(null);
            const [participants, setParticipants] = useState([]);
            const [isLocked, setIsLocked] = useState(false);
            const [activeUserId, setActiveUserId] = useState(null);
            const [roomInput, setRoomInput] = useState('');
            const [newRoomName, setNewRoomName] = useState('');
            const [userName, setUserName] = useState('');
            const [userTeam, setUserTeam] = useState('redbull');
            const [isDrawerOpen, setIsDrawerOpen] = useState(false);
            const [history, setHistory] = useState(() => JSON.parse(localStorage.getItem('f1_history') || '[]'));
            const [selectedRaceIdx, setSelectedRaceIdx] = useState(0);

            const now = new Date();
            const selectedRace = CALENDAR_2026[selectedRaceIdx];
            const daysRemaining = Math.max(0, Math.ceil((new Date(selectedRace.date) - now) / (1000 * 60 * 60 * 24)));
            const completedRaces = CALENDAR_2026.filter(r => new Date(r.date) < now).length;

            const updateDB = async (newList, lockState) => {
                setParticipants(newList);
                setIsLocked(lockState);
                if (room) {
                    await sb.from('f1_rooms').update({ 
                        data: { participants: newList, isLocked: lockState } 
                    }).eq('code', room.code);
                }
            };

            const handleJoin = async (code) => {
                const { data } = await sb.from('f1_rooms').select().eq('code', code.toUpperCase()).single();
                if (data) { 
                    setRoom(data); 
                    setParticipants(data.data.participants || []); 
                    setIsLocked(data.data.isLocked || false); 
                    
                    const newHist = [{code: data.code, name: data.name}, ...history.filter(h => h.code !== data.code)].slice(0, 8);
                    setHistory(newHist);
                    localStorage.setItem('f1_history', JSON.stringify(newHist));
                    setView('dashboard'); 
                } else { alert("Room not found"); }
            };

            const handleCreate = async () => {
                if (!newRoomName) return;
                const code = Math.random().toString(36).substring(2, 6).toUpperCase();
                const { data } = await sb.from('f1_rooms').insert([{ 
                    code, name: newRoomName, data: { participants: [], isLocked: false } 
                }]).select().single();
                if (data) handleJoin(code);
            };

            const getAcc = (p) => {
                if (!p?.predictions || p.predictions.length === 0) return 0;
                return Math.round((p.predictions.filter(x => x.done).length / p.predictions.length) * 100);
            };

            if (view === 'landing') return (
                <div className="max-w-6xl mx-auto p-6 pt-12 min-h-screen flex flex-col">
                    <h1 className="text-4xl f1-font italic mb-12 tracking-tighter text-center">üèéüèÅ F1 <span className="f1-red">PADDOCK</span></h1>
                    <div className="grid lg:grid-cols-3 gap-8 flex-1">
                        <div className="space-y-6">
                            <div className="f1-glass p-8 rounded-3xl">
                                <h3 className="f1-font text-[10px] mb-6 opacity-50 tracking-widest">Join Grid</h3>
                                <input className="w-full bg-transparent border-b border-zinc-800 p-4 mb-6 text-center outline-none font-bold uppercase" placeholder="CODE" value={roomInput} onChange={e => setRoomInput(e.target.value)} />
                                <button onClick={() => handleJoin(roomInput)} className="w-full f1-bg-red p-4 rounded-xl f1-font text-[10px]">Join</button>
                            </div>
                            <div className="f1-glass p-8 rounded-3xl">
                                <h3 className="f1-font text-[10px] mb-6 opacity-50 tracking-widest">New Session</h3>
                                <input className="w-full bg-transparent border-b border-zinc-800 p-4 mb-6 text-center outline-none font-bold uppercase" placeholder="NAME" value={newRoomName} onChange={e => setNewRoomName(e.target.value)} />
                                <button onClick={handleCreate} className="w-full f1-bg-red p-4 rounded-xl f1-font text-[10px]">Create Room</button>
                            </div>
                        </div>

                        <div className="f1-glass p-8 rounded-[2.5rem]">
                            <h2 className="f1-font text-[10px] mb-8 opacity-50 tracking-widest italic">Recent Rooms</h2>
                            <div className="space-y-4 max-h-[400px] overflow-y-auto pr-2">
                                {history.length === 0 && <p className="text-xs opacity-20 italic">No history yet...</p>}
                                {history.map(h => (
                                    <div key={h.code} onClick={() => handleJoin(h.code)} className="bg-white/5 p-5 rounded-2xl flex items-center justify-between cursor-pointer hover:bg-white/10 transition group">
                                        <p className="f1-font text-xs group-hover:text-red-500 transition">{h.name}</p>
                                        <span className="text-[10px] opacity-40 font-bold tracking-widest uppercase">{h.code}</span>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="f1-glass p-8 rounded-[2.5rem] flex flex-col justify-between">
                            <h2 className="f1-font text-[10px] mb-6 opacity-50 tracking-widest italic text-center">Race Control</h2>
                            <select className="w-full bg-zinc-900 p-3 rounded-xl text-xs font-bold uppercase outline-none mb-6 border border-zinc-800 text-white" 
                                    value={selectedRaceIdx} onChange={e => setSelectedRaceIdx(parseInt(e.target.value))}>
                                {CALENDAR_2026.map((r, i) => <option key={i} value={i}>{r.name}</option>)}
                            </select>
                            <div className="text-center">
                                <p className="text-6xl f1-font f1-red italic tracking-tighter mb-2 leading-none">{daysRemaining}</p>
                                <p className="text-[10px] font-black opacity-40 tracking-[0.3em] uppercase">Days Until Race</p>
                            </div>
                            <div className="mt-8 pt-6 border-t border-zinc-900 text-center">
                                <p className="text-sm font-black italic uppercase opacity-60">{selectedRace.name} GP</p>
                                <p className="text-[10px] font-bold opacity-30 uppercase">{new Date(selectedRace.date).toDateString()}</p>
                            </div>
                        </div>
                    </div>
                </div>
            );

            if (view === 'dashboard') {
                const sorted = [...participants].sort((a, b) => getAcc(b) - getAcc(a));
                const p1 = sorted
