<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>F1 Paddock V2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body {
      background:black;
      color:white;
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
    }
    .glass {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .grad {
      background: linear-gradient(90deg,#e10600,#ff3b3b);
    }
  </style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">

/* ===================== SUPABASE ===================== */
const SB_URL = "https://anlktalskporlebnghpp.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFubGt0YWxza3BvcmxlYm5naHBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NDA0NTksImV4cCI6MjA4NDMxNjQ1OX0.fF8Li77jRqGqtTk2CRIXR1J1SS8AVb2YeuXzT-5J-Eg";

const supabase = supabaseJs.createClient(SB_URL, SB_KEY);

/* ===================== CONSTANTS ===================== */

const TEAMS = {
  ferrari: "#F91536",
  redbull: "#3671C6",
  mercedes: "#6CD3BF",
  mclaren: "#FF8000",
  aston: "#229971",
  alpine: "#0093CC",
  williams: "#64C4FF",
  haas: "#B6BABD"
};

/* ===================== APP ===================== */

const { useState, useEffect } = React;

function App() {
  const [view, setView] = useState("landing");
  const [room, setRoom] = useState(null);
  const [participants, setParticipants] = useState([]);
  const [name, setName] = useState("");
  const [team, setTeam] = useState("ferrari");
  const [roomInput, setRoomInput] = useState("");
  const [raceList, setRaceList] = useState([]);
  const [activeRace, setActiveRace] = useState(null);

  /* ========== F1 CALENDAR (LIVE) ========== */
  useEffect(() => {
    fetch("https://ergast.com/api/f1/current.json")
      .then(r => r.json())
      .then(data => {
        const races = data.MRData.RaceTable.Races.map(r => ({
          key: r.round,
          name: r.raceName,
          date: new Date(`${r.date}T${r.time || "00:00:00Z"}`)
        }));
        setRaceList(races);
        const upcoming = races.find(r => r.date > new Date());
        setActiveRace(upcoming || races[0]);
      });
  }, []);

  /* ========== ROOM CREATE ========== */
  async function createRoom() {
    const code = Math.random().toString(36).substring(2,8).toUpperCase();
    const { data, error } = await supabase
      .from("rooms")
      .insert({ code, name: "F1 Championship" })
      .select()
      .single();

    if (error) return alert(error.message);
    setRoom(data);
    setView("room");
  }

  /* ========== ROOM JOIN ========== */
  async function joinRoom() {
    const { data, error } = await supabase
      .from("rooms")
      .select()
      .eq("code", roomInput.toUpperCase())
      .single();

    if (error) return alert("Room not found");
    setRoom(data);
    loadParticipants(data.id);
    setView("room");
  }

  async function loadParticipants(roomId) {
    const { data } = await supabase
      .from("participants")
      .select()
      .eq("room_id", roomId);
    setParticipants(data || []);
  }

  /* ========== ADD PARTICIPANT ========== */
  async function addParticipant() {
    if (!name) return;
    await supabase.from("participants").insert({
      room_id: room.id,
      name,
      team_color: team
    });
    setName("");
    loadParticipants(room.id);
  }

  /* ===================== UI ===================== */

  if (view === "landing") {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center gap-6">
        <h1 className="text-4xl font-black">F1 PADDOCK</h1>

        {activeRace && (
          <div className="glass p-4 rounded-xl text-center">
            <p className="text-sm text-gray-400">Next Race</p>
            <p className="font-bold">{activeRace.name}</p>
            <Countdown target={activeRace.date} />
          </div>
        )}

        <div className="glass p-6 rounded-xl w-80">
          <input
            className="w-full p-3 mb-3 bg-black border border-gray-700"
            placeholder="ROOM CODE"
            value={roomInput}
            onChange={e => setRoomInput(e.target.value)}
          />
          <div className="flex gap-2">
            <button onClick={createRoom} className="grad flex-1 p-3 font-bold">
              Create
            </button>
            <button onClick={joinRoom} className="bg-white text-black flex-1 p-3 font-bold">
              Join
            </button>
          </div>
        </div>
      </div>
    );
  }

  if (view === "room") {
    return (
      <div className="max-w-xl mx-auto p-6">
        <div className="flex justify-between mb-4">
          <div>
            <p className="text-sm text-gray-400">Room Code</p>
            <div className="flex gap-2 items-center">
              <p className="font-mono text-red-500">{room.code}</p>
              <button
                onClick={() => navigator.clipboard.writeText(room.code)}
                className="text-xs border px-2"
              >
                Copy
              </button>
            </div>
          </div>
          <button onClick={() => setView("landing")} className="text-sm text-gray-400">
            Exit
          </button>
        </div>

        <div className="glass p-4 rounded-xl mb-6">
          <input
            className="w-full p-3 bg-black border mb-2"
            placeholder="Your Name"
            value={name}
            onChange={e => setName(e.target.value)}
          />
          <select
            className="w-full p-3 bg-black border mb-2"
            value={team}
            onChange={e => setTeam(e.target.value)}
          >
            {Object.keys(TEAMS).map(t => (
              <option key={t} value={t}>{t}</option>
            ))}
          </select>
          <button onClick={addParticipant} className="grad w-full p-3 font-bold">
            Join as Strategist
          </button>
        </div>

        <div className="space-y-3">
          {participants.map(p => (
            <div
              key={p.id}
              className="glass p-4 rounded-xl border-l-4"
              style={{ borderColor: TEAMS[p.team_color] }}
            >
              <p className="font-bold">{p.name}</p>
              <p className="text-xs text-gray-400">{p.team_color}</p>
            </div>
          ))}
        </div>
      </div>
    );
  }
}

/* ===================== COUNTDOWN ===================== */

function Countdown({ target }) {
  const [time, setTime] = useState("");

  useEffect(() => {
    const i = setInterval(() => {
      const diff = target - new Date();
      if (diff <= 0) {
        setTime("LIVE");
        clearInterval(i);
      } else {
        const d = Math.floor(diff / 86400000);
        const h = Math.floor(diff / 3600000) % 24;
        const m = Math.floor(diff / 60000) % 60;
        setTime(`${d}d ${h}h ${m}m`);
      }
    }, 1000);
    return () => clearInterval(i);
  }, [target]);

  return <p className="font-mono">{time}</p>;
}

/* ===================== RENDER ===================== */

ReactDOM.createRoot(document.getElementById("root")).render(<App />);

</script>
</body>
</html>
