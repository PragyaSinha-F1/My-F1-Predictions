<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Paddock 2026 | IST</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;900&display=swap');
        body { background-color: #050505; color: #e4e4e7; font-family: 'Inter', sans-serif; }
        .f1-font { font-family: 'Outfit', sans-serif; font-weight: 900; text-transform: uppercase; font-style: italic; }
        .f1-glass { background: rgba(15, 15, 15, 0.7); border: 1px solid rgba(255, 255, 255, 0.08); backdrop-filter: blur(12px); }
        .f1-red { color: #e10600; }
        .f1-bg-red { background-color: #e10600; }
        .podium-pillar { transition: all 1s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Constants
        const SB_URL = "https://gyzflcxqehesojhimokd.supabase.co"; 
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd5emZsY3hxZWhlc29qaGltb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMzQ4MjcsImV4cCI6MjA4MzcxMDgyN30.fOW7qr9cNEUp6otJU2f-tXtOJxRX4Wge9R76OXE-_Tk";
        const sb = supabase.createClient(SB_URL, SB_KEY);

        const TEAMS = {
            ferrari: { name: 'Ferrari', color: '#F91536' },
            redbull: { name: 'Red Bull Ford', color: '#3671C6' },
            mclaren: { name: 'McLaren', color: '#FF8000' },
            mercedes: { name: 'Mercedes', color: '#6CD3BF' },
            aston: { name: 'Aston Honda', color: '#229971' },
            audi: { name: 'Audi F1', color: '#f5f5f5' }, 
            williams: { name: 'Williams', color: '#64C4FF' },
            alpine: { name: 'Alpine', color: '#0093CC' },
            haas: { name: 'Haas', color: '#B6BABD' },
            rb: { name: 'Racing Bulls', color: '#6692FF' }
        };

        const CALENDAR_2026 = [
            { name: "Australia", date: "2026-03-08" }, { name: "China", date: "2026-03-15" },
            { name: "Japan", date: "2026-03-29" }, { name: "Bahrain", date: "2026-04-12" },
            { name: "Saudi Arabia", date: "2026-04-19" }, { name: "Miami", date: "2026-05-03" },
            { name: "Canada", date: "2026-05-24" }, { name: "Monaco", date: "2026-06-07" },
            { name: "Spain (Madrid)", date: "2026-09-13" }, { name: "Abu Dhabi", date: "2026-12-06" }
        ];

        // UI Components
        function ProgressCircle({ completed, total }) {
            const radius = 40;
            const circum = 2 * Math.PI * radius;
            const offset = circum - (completed / total) * circum;
            return (
                <div className="flex flex-col items-center">
                    <svg width="100" height="100" className="transform -rotate-90">
                        <circle cx="50" cy="50" r={radius} fill="transparent" stroke="#18181b" strokeWidth="8" />
                        <circle cx="50" cy="50" r={radius} fill="transparent" stroke="#e10600" strokeWidth="8" 
                            strokeDasharray={circum} strokeDashoffset={offset} strokeLinecap="round" />
                    </svg>
                    <div className="mt-[-60px] mb-[30px] f1-font text-lg italic">{completed}/{total}</div>
                    <p className="text-[10px] opacity-40 f1-font">Season Progress</p>
                </div>
            );
        }

        function App() {
            const [view, setView] = useState('landing');
            const [room, setRoom] = useState(null);
            const [participants, setParticipants] = useState([]);
            const [roomInput, setRoomInput] = useState('');
            const [newName, setNewName] = useState('');
            const [selectedTeam, setSelectedTeam] = useState('ferrari');
            const [isDrawerOpen, setIsDrawerOpen] = useState(false);
            const [selectedRaceIdx, setSelectedRaceIdx] = useState(0);

            // Helpers
            const getAccuracy = (p) => {
                if (!p.predictions || p.predictions.length === 0) return 0;
                const correct = p.predictions.filter(x => x.done).length;
                return Math.round((correct / p.predictions.length) * 100);
            };

            const sortedParticipants = [...participants].sort((a, b) => {
                const accA = getAccuracy(a);
                const accB = getAccuracy(b);
                if (accB !== accA) return accB - accA;
                return a.name.localeCompare(b.name); // Tie breaker: Alphabetical
            });

            // Database Actions
            const syncDB = async (newList) => {
                setParticipants(newList);
                if (room) {
                    await sb.from('f1_rooms').update({ data: { participants: newList } }).eq('code', room.code);
                }
            };

            const handleJoin = async (code) => {
                const { data } = await sb.from('f1_rooms').select().eq('code', code.toUpperCase()).single();
                if (data) {
                    setRoom(data);
                    setParticipants(data.data.participants || []);
                    setView('dashboard');
                } else { alert("Room not found!"); }
            };

            const handleCreate = async () => {
                const name = prompt("Enter Room Name:");
                if (!name) return;
                const code = Math.random().toString(36).substring(2, 6).toUpperCase();
                const { data } = await sb.from('f1_rooms').insert([{ code, name, data: { participants: [] } }]).select().single();
                if (data) handleJoin(code);
            };

            // Views
            if (view === 'landing') return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 space-y-12">
                    <div className="text-center">
                        <h1 className="text-6xl f1-font italic tracking-tighter mb-2">F1 <span className="f1-red">PADDOCK</span></h1>
                        <p className="text-xs opacity-40 font-bold tracking-[0.5em] uppercase">2026 Strategy Portal</p>
                    </div>

                    <div className="grid md:grid-cols-2 gap-6 w-full max-w-4xl">
                        <div className="f1-glass p-8 rounded-[2rem] flex flex-col justify-between h-64">
                            <div>
                                <h2 className="f1-font text-xs opacity-50 mb-4">Enter Grid</h2>
                                <input className="w-full bg-transparent border-b-2 border-zinc-800 p-2 text-2xl font-black outline-none mb-4 uppercase" 
                                    placeholder="CODE" value={roomInput} onChange={e => setRoomInput(e.target.value)} />
                            </div>
                            <button onClick={() => handleJoin(roomInput)} className="f1-bg-red w-full py-4 rounded-xl f1-font text-sm italic">Join Session</button>
                        </div>

                        <div className="f1-glass p-8 rounded-[2rem] flex flex-col justify-center items-center h-64 border-dashed border-2 border-white/10">
                            <button onClick={handleCreate} className="hover:scale-105 transition-transform">
                                <div className="w-16 h-16 bg-white/5 rounded-full flex items-center justify-center mb-4">‚ûï</div>
                                <p className="f1-font text-xs opacity-50">Create New Room</p>
                            </button>
                        </div>
                    </div>

                    <div className="f1-glass p-8 rounded-[3rem] w-full max-w-4xl flex items-center justify-between">
                        <div className="flex-1">
                            <h3 className="f1-font text-xs opacity-40 mb-2 tracking-widest">Next Race</h3>
                            <select className="bg-transparent f1-font text-xl outline-none" onChange={e => setSelectedRaceIdx(parseInt(e.target.value))}>
                                {CALENDAR_2026.map((r, i) => <option key={i} value={i} className="bg-black">{r.name}</option>)}
                            </select>
                        </div>
                        <div className="text-right">
                            <p className="text-4xl f1-font f1-red italic">{Math.max(0, Math.ceil((new Date(CALENDAR_2026[selectedRaceIdx].date) - new Date()) / (1000*60*60*24)))}</p>
                            <p className="text-[10px] font-bold opacity-30">DAYS TO LIGHTS OUT</p>
                        </div>
                    </div>
                </div>
            );

            if (view === 'dashboard') {
                const [p1, p2, p3, p4] = sortedParticipants;
                const completed = CALENDAR_2026.filter(r => new Date(r.date) < new Date()).length;

                return (
                    <div className="max-w-6xl mx-auto p-6 pt-10">
                        {/* Header */}
                        <div className="flex justify-between items-center mb-12">
                            <div className="flex items-center gap-6">
                                <button onClick={() => setView('landing')} className="text-[10px] f1-font opacity-30 hover:opacity-100 transition">‚Üê EXIT</button>
                                <h2 className="f1-font text-2xl tracking-tighter italic">üèÅ {room.name}</h2>
                            </div>
                            <div className="flex gap-3">
                                <button onClick={() => { navigator.clipboard.writeText(room.code); alert("Code Copied!"); }} 
                                    className="px-4 py-2 rounded-lg bg-zinc-900 border border-white/5 text-[10px] f1-font">COPY CODE: {room.code}</button>
                                <button onClick={() => setIsDrawerOpen(true)} className="f1-bg-red px-6 py-2 rounded-lg text-[10px] f1-font italic">‚ûï ADD USER</button>
                            </div>
                        </div>

                        {/* Top Section: Podium & Progress */}
                        <div className="grid lg:grid-cols-3 gap-8 mb-12">
                            <div className="lg:col-span-2 f1-glass rounded-[3rem] p-10 flex items-end justify-center gap-6 h-[400px]">
                                {/* P2 */}
                                <div className="flex-1 text-center">
                                    <p className="text-[10px] f1-font mb-2 opacity-50">{p2?.name || 'TBA'}</p>
                                    <div className="podium-pillar rounded-t-2xl" style={{ height: p2 ? '150px' : '20px', background: p2 ? TEAMS[p2.team]?.color : '#111' }}>
                                        <span className="f1-font text-4xl opacity-20 italic">2</span>
                                    </div>
                                </div>
                                {/* P1 */}
                                <div className="flex-1 text-center">
                                    <p className="f1-font text-sm mb-2">{p1?.name || 'TBA'}</p>
                                    <div className="podium-pillar rounded-t-2xl border-t-4 border-white/20 shadow-[0_-20px_50px_rgba(225,6,0,0.2)]" 
                                        style={{ height: p1 ? '220px' : '20px', background: p1 ? TEAMS[p1.team]?.color : '#222' }}>
                                        <span className="f1-font text-6xl opacity-30 italic">1</span>
                                    </div>
                                </div>
                                {/* P3 */}
                                <div className="flex-1 text-center">
                                    <p className="text-[10px] f1-font mb-2 opacity-50">{p3?.name || 'TBA'}</p>
                                    <div className="podium-pillar rounded-t-2xl" style={{ height: p3 ? '100px' : '20px', background: p3 ? TEAMS[p3.team]?.color : '#0a0a0a' }}>
                                        <span className="f1-font text-2xl opacity-10 italic">3</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="f1-glass rounded-[3rem] flex items-center justify-center p-8">
                                <ProgressCircle completed={completed} total={CALENDAR_2026.length} />
                            </div>
                        </div>

                        {/* Participant Grid */}
                        <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
                            {sortedParticipants.map((p, idx) => (
                                <div key={p.id} className="f1-glass p-6 rounded-[2rem] border-l-4 relative group" style={{ borderColor: TEAMS[p.team]?.color }}>
                                    <div className="flex justify-between items-start mb-4">
                                        <p className="text-[8px] f1-font opacity-40">{TEAMS[p.team].name}</p>
                                        <p className="f1-font f1-red italic text-xl">{getAccuracy(p)}%</p>
                                    </div>
                                    <h4 className="f1-font text-lg tracking-tight mb-4">{p.name}</h4>
                                    <button onClick={() => {
                                        // Simple prediction adder for basics
                                        const txt = prompt("Enter Prediction:");
                                        if(!txt) return;
                                        const updated = participants.map(u => u.id === p.id ? {...u, predictions: [...(u.predictions||[]), {id: Date.now(), text: txt, done: false}]} : u);
                                        syncDB(updated);
                                    }} className="w-full py-2 bg-white/5 rounded-lg text-[9px] f1-font hover:bg-white/10 transition">Manage Predictions</button>
                                </div>
                            ))}
                        </div>

                        {/* Add User Drawer */}
                        {isDrawerOpen && (
                            <div className="fixed inset-0 bg-black/80 backdrop-blur-md z-50 flex items-center justify-center p-6">
                                <div className="f1-glass max-w-sm w-full p-10 rounded-[2.5rem] border-red-600/30 border-2">
                                    <h2 className="f1-font text-xl italic mb-8">Sign Strategist</h2>
                                    
                                    <label className="text-[10px] f1-font opacity-40 block mb-2 uppercase tracking-widest">Name</label>
                                    <input className="w-full bg-zinc-900 border border-zinc-800 p-4 rounded-xl mb-6 outline-none f1-font italic text-sm" 
                                        placeholder="PILOT NAME" value={newName} onChange={e => setNewName(e.target.value)} />

                                    <label className="text-[10px] f1-font opacity-40 block mb-2 uppercase tracking-widest">Constructors Team</label>
                                    <select className="w-full bg-zinc-900 border border-zinc-800 p-4 rounded-xl mb-8 outline-none text-xs font-bold uppercase"
                                        value={selectedTeam} onChange={e => setSelectedTeam(e.target.value)}>
                                        {Object.entries(TEAMS).map(([id, t]) => <option key={id} value={id}>{t.name}</option>)}
                                    </select>

                                    <div className="flex gap-4">
                                        <button onClick={() => setIsDrawerOpen(false)} className="flex-1 py-4 text-xs font-bold opacity-40">CANCEL</button>
                                        <button onClick={() => {
                                            if(!newName) return;
                                            syncDB([...participants, { id: Date.now(), name: newName, team: selectedTeam, predictions: [] }]);
                                            setNewName('');
                                            setIsDrawerOpen(false);
                                        }} className="flex-1 f1-bg-red py-4 rounded-xl f1-font text-xs italic">CONFIRM</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
