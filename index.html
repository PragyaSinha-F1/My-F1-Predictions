<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>F1 Paddock V2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body {
      background: black;
      color: white;
      font-family: system-ui, sans-serif;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    /* =========================
       SUPABASE (CORRECT)
    ========================= */
    const SUPABASE_URL = "https://anlktalskporlebnghpp.supabase.co";
    const SUPABASE_ANON =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFubGt0YWxza3BvcmxlYm5naHBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NDA0NTksImV4cCI6MjA4NDMxNjQ1OX0.fF8Li77jRqGqtTk2CRIXR1J1SS8AVb2YeuXzT-5J-Eg";

    const supabase = window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_ANON
    );

    /* =========================
       APP
    ========================= */
    function App() {
      const [view, setView] = useState("landing");
      const [roomCode, setRoomCode] = useState("");
      const [room, setRoom] = useState(null);
      const [name, setName] = useState("");
      const [prediction, setPrediction] = useState("");
      const [predictions, setPredictions] = useState([]);

      /* =========================
         CREATE ROOM (FIXED)
      ========================= */
      const createRoom = async () => {
        const code = Math.random().toString(36).substring(2, 8).toUpperCase();

        const { data, error } = await supabase
          .from("rooms")
          .insert({
            code: code,
            name: "Main Room"   // ðŸ”´ REQUIRED FIELD (FIX)
          })
          .select()
          .single();

        if (error) {
          console.error(error);
          alert("Failed to create room");
          return;
        }

        setRoom(data);
        setRoomCode(code);
        setView("room");
      };

      /* =========================
         JOIN ROOM
      ========================= */
      const joinRoom = async () => {
        const { data, error } = await supabase
          .from("rooms")
          .select("*")
          .eq("code", roomCode)
          .single();

        if (error || !data) {
          alert("Room not found");
          return;
        }

        setRoom(data);
        setView("room");
        loadPredictions(data.id);
      };

      /* =========================
         LOAD PREDICTIONS
      ========================= */
      const loadPredictions = async (roomId) => {
        const { data } = await supabase
          .from("predictions")
          .select("*")
          .eq("room_id", roomId)
          .order("created_at");

        setPredictions(data || []);
      };

      /* =========================
         ADD PREDICTION
      ========================= */
      const addPrediction = async () => {
        if (!prediction || !name || !room) return;

        const { error } = await supabase
          .from("predictions")
          .insert({
            room_id: room.id,
            user_name: name,
            text: prediction
          });

        if (error) {
          alert("Failed to save prediction");
          return;
        }

        setPrediction("");
        loadPredictions(room.id);
      };

      /* =========================
         UI
      ========================= */
      if (view === "landing") {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="bg-zinc-900 p-6 rounded-xl w-80 text-center">
              <h1 className="text-2xl font-bold mb-4">F1 PADDOCK</h1>

              <input
                className="w-full mb-3 p-2 bg-black border border-zinc-700 rounded"
                placeholder="ROOM CODE"
                value={roomCode}
                onChange={(e) => setRoomCode(e.target.value.toUpperCase())}
              />

              <div className="flex gap-2">
                <button
                  onClick={createRoom}
                  className="flex-1 bg-red-600 p-2 rounded font-bold"
                >
                  Create
                </button>
                <button
                  onClick={joinRoom}
                  className="flex-1 bg-white text-black p-2 rounded font-bold"
                >
                  Join
                </button>
              </div>
            </div>
          </div>
        );
      }

      if (view === "room" && room) {
        return (
          <div className="max-w-xl mx-auto p-6">
            <div className="flex justify-between mb-4">
              <div>
                Room:
                <span className="ml-2 text-red-500 font-mono">{room.code}</span>
                <button
                  className="ml-2 text-xs border px-2"
                  onClick={() => navigator.clipboard.writeText(room.code)}
                >
                  Copy
                </button>
              </div>
              <button onClick={() => setView("landing")}>Exit</button>
            </div>

            <input
              className="w-full mb-2 p-2 bg-black border border-zinc-700 rounded"
              placeholder="Your name"
              value={name}
              onChange={(e) => setName(e.target.value)}
            />

            <input
              className="w-full mb-2 p-2 bg-black border border-zinc-700 rounded"
              placeholder="Your prediction"
              value={prediction}
              onChange={(e) => setPrediction(e.target.value)}
            />

            <button
              onClick={addPrediction}
              className="w-full bg-red-600 p-2 rounded font-bold mb-4"
            >
              Add Prediction
            </button>

            <div className="space-y-2">
              {predictions.map((p) => (
                <div
                  key={p.id}
                  className="border border-zinc-800 p-2 rounded"
                >
                  <b>{p.user_name}</b>: {p.text}
                </div>
              ))}
            </div>
          </div>
        );
      }

      return null;
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
