<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Paddock 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;900&family=Inter:wght@400;700&display=swap');
        body { background-color: #050505; color: white; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .f1-font { font-family: 'Outfit', sans-serif; font-weight: 900; text-transform: uppercase; font-style: italic; }
        .f1-glass { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); backdrop-filter: blur(12px); }
        .pillar { transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .f1-red { color: #e10600; }
        .f1-bg-red { background-color: #e10600; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const SB_URL = "https://gyzflcxqehesojhimokd.supabase.co"; 
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd5emZsY3hxZWhlc29qaGltb2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMzQ4MjcsImV4cCI6MjA4MzcxMDgyN30.fOW7qr9cNEUp6otJU2f-tXtOJxRX4Wge9R76OXE-_Tk";
        const sb = supabase.createClient(SB_URL, SB_KEY);

        const TEAMS = {
            ferrari: { name: 'Ferrari', color: '#F91536' },
            redbull: { name: 'Red Bull Ford', color: '#3671C6' },
            mercedes: { name: 'Mercedes', color: '#6CD3BF' },
            mclaren: { name: 'McLaren', color: '#FF8000' },
            audi: { name: 'Audi F1', color: '#f5f5f5' },
            aston: { name: 'Aston Honda', color: '#229971' },
            rb: { name: 'Racing Bulls', color: '#6692FF' },
            williams: { name: 'Williams', color: '#64C4FF' },
            alpine: { name: 'Alpine', color: '#0093CC' },
            haas: { name: 'Haas', color: '#B6BABD' }
        };

        const App = () => {
            const [view, setView] = useState('landing');
            const [room, setRoom] = useState(null);
            const [participants, setParticipants] = useState([]);
            const [activeUser, setActiveUser] = useState(null);
            const [roomCode, setRoomCode] = useState('');
            const [isDrawerOpen, setIsDrawerOpen] = useState(false);
            const [formName, setFormName] = useState('');
            const [formTeam, setFormTeam] = useState('ferrari');
            const [predText, setPredText] = useState('');

            const getAcc = (p) => {
                if (!p?.predictions || p.predictions.length === 0) return 0;
                return Math.round((p.predictions.filter(x => x.done).length / p.predictions.length) * 100);
            };

            const sorted = useMemo(() => {
                return [...participants].sort((a, b) => {
                    const diff = getAcc(b) - getAcc(a);
                    return diff !== 0 ? diff : (a.name || "").localeCompare(b.name || "");
                });
            }, [participants]);

            const syncDB = async (list) => {
                setParticipants(list);
                if (room) await sb.from('f1_rooms').update({ data: { participants: list } }).eq('code', room.code);
            };

            const joinRoom = async (code) => {
                const { data } = await sb.from('f1_rooms').select().eq('code', code.toUpperCase()).single();
                if (data) { setRoom(data); setParticipants(data.data.participants || []); setView('dashboard'); }
                else alert("Room not found");
            };

            const createRoom = async () => {
                const code = Math.random().toString(36).substring(2, 6).toUpperCase();
                const { data } = await sb.from('f1_rooms').insert([{ code, name: "2026 Grid", data: { participants: [] } }]).select().single();
                if (data) joinRoom(code);
            };

            // Podium Helper: Generate the Dual Strip Background
            const getPodiumStyle = (pA, pB) => {
                const colorA = TEAMS[pA?.team]?.color || '#222';
                const colorB = TEAMS[pB?.team]?.color || '#222';
                if (pB && getAcc(pA) === getAcc(pB)) {
                    return { background: `repeating-linear-gradient(-45deg, ${colorA}, ${colorA} 15px, ${colorB} 15px, ${colorB} 30px)` };
                }
                return { background: colorA };
            };

            if (view === 'landing') return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-black">
                    <h1 className="text-7xl f1-font italic tracking-tighter mb-10">F1<span className="f1-red">PADDOCK</span></h1>
                    <div className="f1-glass p-8 rounded-[2.5rem] w-full max-w-sm">
                        <input className="w-full bg-transparent border-b border-zinc-800 p-4 text-2xl f1-font text-center outline-none mb-6 uppercase" 
                            placeholder="CODE" value={roomCode} onChange={e => setRoomCode(e.target.value)} />
                        <div className="grid grid-cols-2 gap-4">
                            <button onClick={() => joinRoom(roomCode)} className="f1-bg-red py-4 rounded-xl f1-font text-[10px]">JOIN</button>
                            <button onClick={createRoom} className="bg-zinc-900 py-4 rounded-xl f1-font text-[10px]">NEW</button>
                        </div>
                    </div>
                </div>
            );

            if (view === 'dashboard') {
                const [p1, p2, p3, p4] = sorted;
                const tie12 = p1 && p2 && getAcc(p1) === getAcc(p2);
                const tie23 = p2 && p3 && getAcc(p2) === getAcc(p3);
                const tie34 = p3 && p4 && getAcc(p3) === getAcc(p4);

                return (
                    <div className="max-w-5xl mx-auto p-6 pt-12">
                        <div className="flex justify-between items-center mb-10">
                            <button onClick={() => setView('landing')} className="f1-font text-[10px] opacity-40">‚Üê EXIT</button>
                            <h2 className="f1-font text-xl italic tracking-tight">üèÅ ROOM {room.code}</h2>
                            <button onClick={() => setIsDrawerOpen(true)} className="f1-bg-red px-6 py-2 rounded-lg f1-font text-[10px]">GRID +</button>
                        </div>

                        {/* PODIUM SECTION */}
                        <div className="f1-glass rounded-[3rem] h-[450px] p-10 flex items-end justify-center gap-4 relative overflow-hidden mb-12">
                            <div className="absolute top-8 left-10 opacity-20 f1-font text-[10px] tracking-widest">Podium Status</div>
                            
                            {/* P2 Pillar (Left) */}
                            <div className="flex-1 flex flex-col items-center">
                                <p className="text-[10px] font-bold opacity-70 mb-2 uppercase text-center h-4 truncate w-full px-2">
                                    {tie23 ? `${p2?.name} & ${p3?.name}` : (p2?.name || '---')}
                                </p>
                                <div className="pillar w-full rounded-t-xl flex items-center justify-center f1-font text-4xl italic" 
                                    style={{ 
                                        height: p2 ? '160px' : '40px', 
                                        ...getPodiumStyle(p2, p3),
                                        color: p2?.team === 'audi' ? '#000' : '#fff'
                                    }}>
                                    {tie23 ? '=' : '2'}
                                </div>
                            </div>

                            {/* P1 Pillar (Center) */}
                            <div className="flex-1 flex flex-col items-center">
                                <p className="f1-font text-sm mb-2 uppercase text-center h-5 truncate w-full px-2">
                                    {tie12 ? `${p1?.name} & ${p2?.name}` : (p1?.name || '---')}
                                </p>
                                <div className="pillar w-full rounded-t-xl flex items-center justify-center f1-font text-7xl italic border-t-4 border-white/20 shadow-2xl" 
                                    style={{ 
                                        height: p1 ? '240px' : '40px', 
                                        ...getPodiumStyle(p1, p2),
                                        color: p1?.team === 'audi' ? '#000' : '#fff'
                                    }}>
                                    1
                                </div>
                            </div>

                            {/* P3 Pillar (Right) - Tie 3-4 Fix */}
                            <div className="flex-1 flex flex-col items-center">
                                <p className="text-[10px] font-bold opacity-70 mb-2 uppercase text-center h-4 truncate w-full px-2">
                                    {tie34 ? `${p3?.name} & ${p4?.name}` : (p3?.name || '---')}
                                </p>
                                <div className="pillar w-full rounded-t-xl flex items-center justify-center f1-font text-2xl italic" 
                                    style={{ 
                                        height: p3 ? '110px' : '40px', 
                                        ...getPodiumStyle(p3, p4),
                                        color: p3?.team === 'audi' ? '#000' : '#fff'
                                    }}>
                                    {tie34 ? '=' : '3'}
                                </div>
                            </div>
                        </div>

                        {/* GRID LIST */}
                        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {sorted.map(p => (
                                <div key={p.id} onClick={() => { setActiveUser(p); setView('predictions'); }} className="f1-glass p-6 rounded-[2rem] border-l-8 flex justify-between items-center cursor-pointer hover:scale-[1.02] transition-all" 
                                    style={{ borderLeftColor: TEAMS[p.team]?.color }}>
                                    <div>
                                        <p className="text-[8px] font-bold opacity-30 uppercase">{TEAMS[p.team]?.name}</p>
                                        <h4 className="f1-font text-lg italic tracking-tighter">{p.name}</h4>
                                    </div>
                                    <div className="f1-font text-2xl f1-red italic">{getAcc(p)}%</div>
                                </div>
                            ))}
                        </div>

                        {/* DRAWER */}
                        {isDrawerOpen && (
                            <div className="fixed inset-0 z-50 flex justify-end">
                                <div className="absolute inset-0 bg-black/90 backdrop-blur-md" onClick={() => setIsDrawerOpen(false)} />
                                <div className="relative w-full max-w-sm bg-[#080808] border-l border-zinc-900 p-12 flex flex-col">
                                    <h3 className="f1-font text-2xl italic mb-10">Add To Grid</h3>
                                    <input className="w-full bg-zinc-900 border border-zinc-800 p-4 rounded-xl f1-font text-sm mb-6 outline-none" 
                                        placeholder="NAME" value={formName} onChange={e => setFormName(e.target.value)} />
                                    <select className="w-full bg-zinc-900 border border-zinc-800 p-4 rounded-xl text-xs font-bold uppercase mb-8 outline-none"
                                        value={formTeam} onChange={e => setFormTeam(e.target.value)}>
                                        {Object.entries(TEAMS).map(([id, t]) => (<option key={id} value={id}>{t.name}</option>))}
                                    </select>
                                    <button onClick={() => {
                                        if(!formName) return;
                                        syncDB([...participants, { id: Date.now(), name: formName, team: formTeam, predictions: [] }]);
                                        setFormName(''); setIsDrawerOpen(false);
                                    }} className="w-full f1-bg-red py-5 rounded-2xl f1-font text-xs italic">SIGN STRATEGIST</button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            if (view === 'predictions') {
                const p = participants.find(u => u.id === activeUser.id);
                if (!p) return null;

                const addPred = () => {
                    if (!predText) return;
                    const newList = participants.map(u => u.id === p.id ? 
                        {...u, predictions: [...u.predictions, { id: Date.now(), text: predText, done: false }]} : u
                    );
                    syncDB(newList); setPredText('');
                };

                return (
                    <div className="max-w-2xl mx-auto p-6 pt-12">
                        <button onClick={() => setView('dashboard')} className="f1-font text-[10px] opacity-40 mb-10 uppercase">‚Üê DASHBOARD</button>
                        <div className="flex justify-between items-end mb-10 pb-6 border-b border-zinc-900">
                            <div>
                                <p className="text-[10px] font-bold uppercase opacity-30 mb-2">{TEAMS[p.team]?.name}</p>
                                <h1 className="f1-font text-4xl italic leading-none">{p.name}</h1>
                            </div>
                            <div className="f1-font text-5xl f1-red italic">{getAcc(p)}%</div>
                        </div>

                        <div className="flex gap-3 mb-8">
                            <input className="flex-1 f1-glass p-5 rounded-2xl bg-transparent border-zinc-800 outline-none" 
                                placeholder="NEW PREDICTION..." value={predText} onChange={e => setPredText(e.target.value)} onKeyPress={e => e.key === 'Enter' && addPred()} />
                            <button onClick={addPred} className="f1-bg-red px-8 rounded-2xl f1-font text-xs">ADD</button>
                        </div>

                        <div className="space-y-3">
                            {p.predictions.map(pr => (
                                <div key={pr.id} className="f1-glass p-5 rounded-2xl flex items-center justify-between">
                                    <div className="flex items-center gap-6 flex-1 cursor-pointer" onClick={() => {
                                        const newList = participants.map(u => u.id === p.id ? 
                                            {...u, predictions: u.predictions.map(x => x.id === pr.id ? {...x, done: !x.done} : x)} : u
                                        );
                                        syncDB(newList);
                                    }}>
                                        <div className={`w-6 h-6 rounded flex items-center justify-center border-2 ${pr.done ? 'bg-green-500 border-green-500' : 'border-zinc-700'}`}>
                                            {pr.done && <span className="text-black font-black text-xs">‚úì</span>}
                                        </div>
                                        <span className={`text-lg italic tracking-tight ${pr.done ? 'opacity-30 line-through' : 'text-white'}`}>{pr.text}</span>
                                    </div>
                                    <button onClick={() => {
                                        const newList = participants.map(u => u.id === p.id ? {...u, predictions: u.predictions.filter(x => x.id !== pr.id)} : u);
                                        syncDB(newList);
                                    }} className="text-zinc-800 hover:text-red-500">‚úï</button>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
